<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Rover Control</title>
<style>
  body { font-family: Arial; text-align: center; background: #f0f0f0; }
  h1 { margin-bottom: 20px; }
  .button { width: 80px; height: 80px; margin: 10px; font-size: 24px; }
  #ultrasonic { margin-top: 20px; font-size: 18px; }
  #modeToggle { width: 160px; height: 50px; font-size: 20px; margin-top: 20px; }
</style>
</head>
<body>

<h1>ESP32 Rover Control</h1>

<div>
  <button class="button" id="w">W</button><br>
  <button class="button" id="a">A</button>
  <button class="button" id="s">S</button>
  <button class="button" id="d">D</button><br>
  <button class="button" id="x">Stop</button>
</div>

<button id="modeToggle">Toggle Manual/Auto</button>

<div id="ultrasonic">
  <p>Distance: <span id="cm">0</span> cm | <span id="inch">0</span> in</p>
</div>

<!-- Include MQTT library -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  const roverIP = location.hostname; // ESP32 IP on local network
  const buttons = ['w','a','s','d','x'];
  let wPressed=false, aPressed=false, sPressed=false, dPressed=false;

  // ---------------- Handle button press/release ----------------
  buttons.forEach(key => {
    const btn = document.getElementById(key);
    let pressed = false;

    const sendState = (state) => {
      fetch(`http://${roverIP}/press?key=${key}&state=${state}`);
    }

    btn.addEventListener('mousedown', () => { if(key!=='x'){pressed=true; sendState(1);} else sendState(1); });
    btn.addEventListener('mouseup',   () => { if(key!=='x'){pressed=false; sendState(0);} else sendState(0); });
    btn.addEventListener('mouseleave',() => { if(pressed){pressed=false; sendState(0);} });
    btn.addEventListener('touchstart', () => { if(key!=='x'){pressed=true; sendState(1);} else sendState(1); });
    btn.addEventListener('touchend',   () => { if(key!=='x'){pressed=false; sendState(0);} else sendState(0); });
  });

  // ---------------- Manual/Auto toggle ----------------
  const modeBtn = document.getElementById("modeToggle");
  modeBtn.addEventListener('click', () => {
    fetch(`http://${roverIP}/press?key=m&state=1`);
  });

  // ---------------- MQTT for ultrasonic ----------------
  const client  = mqtt.connect('wss://broker.hivemq.com:8000/mqtt');

  client.on('connect', () => {
    console.log('Connected to HiveMQ WebSocket');
    client.subscribe('SmartChargingSystem/Group12/Demo01');
  });

  client.on('message', (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      document.getElementById('cm').innerText = data.cm.toFixed(2);
      document.getElementById('inch').innerText = data.inch.toFixed(2);
    } catch(e){ console.error(e); }
  });
</script>

</body>
</html>
